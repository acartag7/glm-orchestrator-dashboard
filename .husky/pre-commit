#!/bin/sh

# Prevent committing secrets
echo "üîç Checking for secrets..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND_SECRETS=0

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    # Skip binary files
    if file "$FILE" | grep -q binary; then
      continue
    fi

    # npm tokens
    if grep -qE 'npm_[a-zA-Z0-9]{30,}' "$FILE" 2>/dev/null; then
      echo "‚ùå NPM token found in $FILE"
      FOUND_SECRETS=1
    fi

    # Resend API keys
    if grep -qE 're_[a-zA-Z0-9_]{20,}' "$FILE" 2>/dev/null; then
      echo "‚ùå Resend API key found in $FILE"
      FOUND_SECRETS=1
    fi

    # z.ai / Anthropic tokens (hex.base64 format)
    if grep -qE '[0-9a-f]{32}\.[a-zA-Z0-9]{16,}' "$FILE" 2>/dev/null; then
      echo "‚ùå API token (z.ai/Anthropic format) found in $FILE"
      FOUND_SECRETS=1
    fi

    # OpenAI API keys
    if grep -qE 'sk-[a-zA-Z0-9]{40,}' "$FILE" 2>/dev/null; then
      echo "‚ùå OpenAI API key found in $FILE"
      FOUND_SECRETS=1
    fi

    # AWS access keys
    if grep -qE 'AKIA[0-9A-Z]{16}' "$FILE" 2>/dev/null; then
      echo "‚ùå AWS access key found in $FILE"
      FOUND_SECRETS=1
    fi

    # GitHub tokens
    if grep -qE 'gh[pousr]_[A-Za-z0-9_]{36,}' "$FILE" 2>/dev/null; then
      echo "‚ùå GitHub token found in $FILE"
      FOUND_SECRETS=1
    fi

    # Private key detection
    if grep -qE 'BEGIN.*PRIVATE KEY' "$FILE" 2>/dev/null; then
      echo "‚ùå Private key found in $FILE"
      FOUND_SECRETS=1
    fi

    # Generic API key assignments
    if grep -qiE '(API_KEY|AUTH_TOKEN|SECRET_KEY)\s*=\s*["\x27][a-zA-Z0-9_-]{20,}["\x27]' "$FILE" 2>/dev/null; then
      echo "‚ùå Hardcoded credential found in $FILE"
      FOUND_SECRETS=1
    fi
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "‚õî Commit blocked: Secrets detected!"
  echo ""
  echo "Please remove the secret and use environment variables or add file to .gitignore"
  echo ""
  exit 1
fi

echo "‚úÖ No secrets detected"
